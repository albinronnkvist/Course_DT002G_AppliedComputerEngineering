# üìò Guide - Containerization

This section explains how to set up the four containerization templates: `Containerization`, `MicroserviceInfrastructure`, `Microservice`, and `ContainerizationDeployment`.

> üìù You‚Äôll use your previously recorded `T*` values from the [Prerequisites](../../GUIDE_PREREQUISITES.md), [Platform Templates](../Platform/GUIDE_PLATFORM_TEMPLATES.md), and [IAM Templates](../IAM/GUIDE_IAM_TEMPLATES.md) guides throughout these steps.


## üìÇ 1. `Containerization` Template Setup

### 1.1. Create the GitLab Project

- Create a blank GitLab project
  - üìù Record the **Project Name** as `TContainerizationRepositoryName` (e.g., `Containerization`)
  - üìù Record the **Project Slug** as `TContainerizationRepositoryGitLabPath` (e.g., `containerization`)
- Go to **Settings ‚Üí CI/CD ‚Üí Job token permissions**
  - Add your GitLab group to the CI/CD job token allowlist using `TOrgGitLabPath` (e.g., `acme`)

### 1.2. Initialize the Git Repository

```bash
git clone git@gitlab.com:<TOrgGitLabPath>/<TContainerizationRepositoryGitLabPath>.git
cd <project>
git checkout -b main
git commit --allow-empty -m "Initialize main branch"
git push -u origin main
git checkout -b feature/setup-template
```

### 1.3. Generate the project

Generate the project using your `T*` values:

```bash
dotnet new containerization \
  --TOrgName "Acme" \
  --TOrgGitLabPath "acme" \
  --TOrgPackageSourceKey "acme.com" \
  --TOrgPackageSourceValue "https://gitlab.com/api/v4/groups/111111111/-/packages/nuget/index.json" \
  --TContainerizationRepositoryName "Containerization" \
  --TContainerizationRepositoryGitLabPath "containerization" \
  --TProjectPackageSourceValue "https://gitlab.com/api/v4/projects/111111115/packages/nuget/index.json" \
  --TContainerizationApplicationClientId "994dd4d8-3e33-445f-8806-574abe8b1cc7" \
  --TPlatformPulumiRepositoryName "PlatformPulumi" \
  --TPlatformPulumiAzureRepositoryName "PlatformPulumiAzure" \
  --TIamEntraIdRepositoryName "IamEntraId" \
  --TIamAzureRepositoryName "IamAzure" \
  --TMicroserviceRepositoryName "Microservice" \
  --TMicroserviceRepositoryGitLabPath "microservice" \
  --TTenantId "0dab5c50-01cc-4c65-834c-52d042b8ac9e" \
  --TSubscriptionId "39b3120a-dbfd-4aa8-ab24-88b8fe0a30bb" \
  --TLocation "swedencentral" 
```

- `TContainerizationApplicationClientId` is the Application Client ID generated by the `IamEntraId` template (can be found in the Pulumi or Azure portal).
- `TLocation` is the short name for the desired Azure location/region ([see full list of locations](https://gist.github.com/ausfestivus/04e55c7d80229069bf3bc75870630ec8)).

### 1.4. Finalize

- Navigate to the Pulumi project directory: `cd path/to/Pulumi Project`
- Initialize the `dev` stack with Pulumi CLI: `pulumi stack init`
- Commit all generated and updated files.
- Push your feature branch to the remote repository.
- Open a Merge Request and wait for the CI pipeline to finish running to validate your changes.
- After the merge, the CI/CD pipeline will automatically handle building and testing the project, deploying resources, and publishing a NuGet package.

---

## üìÇ 2. `MicroserviceInfrastructure` Template Setup

### 2.1. Create the GitLab Project

- Create a blank GitLab project
  - üìù Record the **Project Name** as `TMicroserviceInfrastructureRepositoryName` (e.g., `MicroserviceInfrastructure`)
  - üìù Record the **Project Slug** as `TMicroserviceInfrastructureRepositoryGitLabPath` (e.g., `microservice-infrastructure`)
- Go to **Settings ‚Üí CI/CD ‚Üí Job token permissions**
  - Add your GitLab group to the CI/CD job token allowlist using `TOrgGitLabPath` (e.g., `acme`)

### 2.2. Initialize the Git Repository

```bash
git clone git@gitlab.com:<TOrgGitLabPath>/<TMicroserviceInfrastructureRepositoryGitLabPath>.git
cd <project>
git checkout -b main
git commit --allow-empty -m "Initialize main branch"
git push -u origin main
git checkout -b feature/setup-template
```

### 2.3. Generate the project

Generate the project using your `T*` values:

```bash
dotnet new microservice-infrastructure \
  --TOrgName "Acme" \
  --TOrgGitLabPath "acme" \
  --TOrgPackageSourceKey "acme.com" \
  --TOrgPackageSourceValue "https://gitlab.com/api/v4/groups/111111111/-/packages/nuget/index.json" \
  --TPlatformPulumiRepositoryName "PlatformPulumi" \
  --TPlatformPulumiAzureRepositoryName "PlatformPulumiAzure" \
  --TIamEntraIdRepositoryName "IamEntraId" \
  --TIamAzureRepositoryName "IamAzure" \
  --TMicroserviceInfrastructureRepositoryName "MicroserviceInfrastructure" \
  --TMicroserviceInfrastructureRepositoryGitLabPath "microservice-infrastructure" \
  --TMicroserviceRepositoryName "Microservice" \
  --TMicroserviceRepositoryGitLabPath "microservice" \
  --TMicroserviceApplicationClientId "dcbfeb6d-de31-417b-a0a6-a5eb9fc8da14" \
  --TTenantId "0dab5c50-01cc-4c65-834c-52d042b8ac9e" \
  --TSubscriptionId "39b3120a-dbfd-4aa8-ab24-88b8fe0a30bb" \
  --TLocation "swedencentral" 
```

- `TMicroserviceApplicationClientId` is the Application Client ID generated by the `IamEntraId` template (can be found in the Pulumi or Azure portal). The same ID will be used in the `Microservice` and `ContainerizationDeployment` templates.

### 2.4. Finalize

- Navigate to the Pulumi project directory: `cd path/to/Pulumi Project`
- Initialize the `dev` stack with Pulumi CLI: `pulumi stack init`
- Create a Pulumi secret specifically named `exampleSecret`: `pulumi config set exampleSecret verysecretvalue --secret`
- Commit all generated and updated files.
- Push your feature branch to the remote repository.
- Open a Merge Request and wait for the CI pipeline to finish running to validate your changes.
- After the merge, the CI/CD pipeline will automatically handle building and testing the project, deploying resources, and publishing a NuGet package.

---

## üìÇ 3. `Microservice` Template Setup

### 3.1. Create the GitLab Project

- Create a blank GitLab project
    - üìù Record the **Project Name** as `TMicroserviceRepositoryName` (e.g., `Microservice`)
    - üìù Record the **Project Slug** as `TMicroserviceRepositoryGitLabPath` (e.g., `microservice`)
- Go to **Settings ‚Üí CI/CD ‚Üí Job token permissions**
    - Add your GitLab group to the CI/CD job token allowlist using `TOrgGitLabPath` (e.g., `acme`)

### 3.2. Initialize the Git Repository

```bash
git clone git@gitlab.com:<TOrgGitLabPath>/<TMicroserviceRepositoryGitLabPath>.git
cd <project>
git checkout -b main
git commit --allow-empty -m "Initialize main branch"
git push -u origin main
git checkout -b feature/setup-template
```

### 3.3. Generate the project

Generate the project using your `T*` values:

```bash
dotnet new microservice \
  --TOrgName "Acme" \
  --TOrgGitLabPath "acme" \
  --TOrgPackageSourceKey "acme.com" \
  --TOrgPackageSourceValue "https://gitlab.com/api/v4/groups/111111111/-/packages/nuget/index.json" \
  --TContainerRegistryName "acmedev" \
  --TContainerizationDeploymentRepositoryName "ContainerizationDeployment" \
  --TContainerizationDeploymentRepositoryGitLabPath "containerization-deployment" \
  --TMicroserviceRepositoryName "Microservice" \
  --TMicroserviceRepositoryGitLabPath "microservice" \
  --TMicroserviceApplicationClientId "dcbfeb6d-de31-417b-a0a6-a5eb9fc8da14" \
  --TTenantId "0dab5c50-01cc-4c65-834c-52d042b8ac9e" \
  --TManagedIdentityClientId "f2994089-05b9-40cd-8b18-aee7115b5ff1" \
  --TVaultUri "https://microservice-dev.vault.azure.net/" 
```

- `TContainerRegistryName` is the Azure Container Registry name generated by the `Containerization` template (can be found in the Pulumi or Azure portal).
- `TManagedIdentityClientId` is the Managed Identity Client ID generated by the `IamEntraId` template for the Microservice project (can be found in the Pulumi or Azure portal).
- `TVaultUri` is the Azure Key Vault URI generated by the `MicroserviceInfrastructure` template (can be found in the Pulumi or Azure portal). 

### 3.4 Create an MR

- Commit all generated and modified files.
- Push your feature branch to the remote repository.
- Open a Merge Request and wait for the CI pipeline to finish to validate your changes.
  - This process will publish a container image to ACR with the name: "`TMicroserviceRepositoryName`-api"
  - üìù Record the generated image tag (e.g., `91e60ee1a8181c3fa31171a4a93f874c98457bb1`) 
  - ‚ö†Ô∏è Important! DO **NOT** MERGE YET. First, complete the configuration of the `ContainerizationDeployment` template as outlined in section [4](#-4-containerizationdeployment-template-setup) below, then continue with section [3.5](#35-finalize).

### 3.5. Finalize

- Once the `ContainerizationDeployment` template has been configured and deployed, go ahead and merge your changes.
- After merging, the CI/CD pipeline will automatically build, test, and deploy the project.
  - As part of this process, it will open a merge request in the `TContainerizationDeployment` repository. Merge that request to finalize the deployment.
- To confirm everything is working as expected, send a GET request to the running API container:: `curl https://<your-domain>/api/v1/examples
`
  - You should receive a response similar to: `"Example property: Example value. Example secret: verysecretvalue."`
  - The value `Example secret: verysecretvalue` confirms that the secret was successfully retrieved from the key vault.

---

## üìÇ 4. `ContainerizationDeployment` Template Setup

### 4.1. Create the GitLab Project

- Create a blank GitLab project
  - üìù Record the **Project Name** as `TContainerizationDeploymentRepositoryName` (e.g., `ContainerizationDeployment`)
  - üìù Record the **Project Slug** as `TContainerizationDeploymentRepositoryGitLabPath` (e.g., `containerization-deployment`)
- Go to **Settings ‚Üí CI/CD ‚Üí Job token permissions**
  - Add your GitLab group to the CI/CD job token allowlist using `TOrgGitLabPath` (e.g., `acme`)

### 4.2 Allow access to the GitLab project via PAT

- Create a new GitLab PAT in your personal account
  - Give it access to: `api`, `read_repository`, `write_repository`
- Go to the GitLab group's settings -> CI/CD -> Variables and add the PAT:
  - Name it `GITLAB_CONTAINERIZATIONDEPLOYMENT_PROJECT_ACCESS_TOKEN`
  - Make it _Protected_, _Masked_, and _Hidden_

### 4.3. Initialize the Git Repository

```bash
git clone git@gitlab.com:<TOrgGitLabPath>/<TContainerizationDeploymentRepositoryName>.git
cd <project>
git checkout -b main
git commit --allow-empty -m "Initialize main branch"
git push -u origin main
git checkout -b feature/setup-template
```

### 4.4. Generate the project

Generate the project using your `T*` values:

```bash
dotnet new containerization-deployment \
  --TOrgName "Acme" \
  --TOrgGitLabPath "acme" \
  --TOrgPackageSourceKey "acme.com" \
  --TOrgPackageSourceValue "https://gitlab.com/api/v4/groups/111111111/-/packages/nuget/index.json" \
  --TPlatformPulumiRepositoryName "PlatformPulumi" \
  --TPlatformPulumiAzureRepositoryName "PlatformPulumiAzure" \
  --TIamAzureRepositoryName "IamAzure" \
  --TContainerizationRepositoryName "Containerization" \
  --TMicroserviceRepositoryName "Microservice" \
  --TMicroserviceApplicationClientId "dcbfeb6d-de31-417b-a0a6-a5eb9fc8da14" \
  --TContainerizationDeploymentRepositoryName "ContainerizationDeployment" \
  --TTenantId "0dab5c50-01cc-4c65-834c-52d042b8ac9e" \
  --TSubscriptionId "39b3120a-dbfd-4aa8-ab24-88b8fe0a30bb" \
  --TLocation "swedencentral" 
```

### 4.5. Finalize

- Navigate to the Pulumi project directory for the microservice: `cd path/to/Microservice Project`
- Initialize the `dev` stack in Pulumi: `pulumi stack init`
- Add the image tag (generated by the `Microservice` project) to the `imageTagApi` field in `Pulumi.dev.yaml` (e.g., `91e60ee1a8181c3fa31171a4a93f874c98457bb1`)
- Commit all generated and modified files.
- Push your feature branch to the remote repository.
- Open a Merge Request and wait for the CI pipeline to complete and validate your changes.
- Once merged, the CI/CD pipeline will automatically build and test the project, and deploy the container.
- Proceed with the setup in section [3.5](#35-finalize) above.

---

## üòµ‚Äçüí´ Troubleshooting

1. If the pipeline fails with the error: `curl: (56) OpenSSL SSL_read: SSL_ERROR_SYSCALL, errno 0`
    - **Cause:** This is a network-related issue while trying to download the .NET install script.
    - **Solution:** Simply re-run the pipeline. As the saying goes, ‚ÄúIf at first you don‚Äôt succeed, try, try again.‚Äù
